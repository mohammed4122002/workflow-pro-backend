generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  LEAVE
}

enum LeaveType {
  ANNUAL
  SICK
  OTHER
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum ReportType {
  HR_SUMMARY
  TASK_SUMMARY
  FIN_SUMMARY
}

model User {
  id             String            @id @default(uuid()) @db.Uuid
  email          String            @unique
  fullName       String
  role           Role
  department     String?
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  employeeProfile EmployeeProfile?
  attendances     Attendance[]
  leaveRequests   LeaveRequest[]
  leaveDecisions  LeaveRequest[]    @relation("LeaveDecider")
  tasksCreated    Task[]            @relation("TaskCreator")
  tasksAssigned   Task[]            @relation("TaskAssignee")
  taskComments    TaskComment[]
  financialRecords FinancialRecord[]
}

model EmployeeProfile {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @unique @db.Uuid
  jobTitle   String
  salaryBase Decimal  @db.Decimal(12, 2)
  hireDate   DateTime @db.Date
  nationalId String?
  address    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Attendance {
  id       String            @id @default(uuid()) @db.Uuid
  userId   String            @db.Uuid
  date     DateTime          @db.Date
  checkIn  DateTime?
  checkOut DateTime?
  status   AttendanceStatus
  note     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model LeaveRequest {
  id          String      @id @default(uuid()) @db.Uuid
  userId      String      @db.Uuid
  fromDate    DateTime    @db.Date
  toDate      DateTime    @db.Date
  type        LeaveType
  reason      String?
  status      LeaveStatus @default(PENDING)
  decidedById String?     @db.Uuid
  decidedAt   DateTime?

  user      User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  decidedBy User? @relation("LeaveDecider", fields: [decidedById], references: [id])

  @@index([userId, fromDate, toDate])
}

model Task {
  id           String       @id @default(uuid()) @db.Uuid
  title        String
  description  String?
  status       TaskStatus   @default(TODO)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?
  createdById  String       @db.Uuid
  assignedToId String?      @db.Uuid
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  createdBy  User  @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignedTo User? @relation("TaskAssignee", fields: [assignedToId], references: [id])
  comments   TaskComment[]

  @@index([createdById])
  @@index([assignedToId])
}

model TaskComment {
  id        String   @id @default(uuid()) @db.Uuid
  taskId    String   @db.Uuid
  userId    String   @db.Uuid
  content   String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
}

model FinancialRecord {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  month      String   @db.VarChar(7)
  salaryPaid Decimal  @db.Decimal(12, 2)
  bonuses    Decimal  @default(0) @db.Decimal(12, 2)
  deductions Decimal  @default(0) @db.Decimal(12, 2)
  notes      String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, month])
}

model ReportSnapshot {
  id        String     @id @default(uuid()) @db.Uuid
  type      ReportType
  rangeFrom DateTime?  @db.Date
  rangeTo   DateTime?  @db.Date
  data      Json
  createdAt DateTime   @default(now())
}

model AiInsightCache {
  id              String     @id @default(uuid()) @db.Uuid
  key             String     @unique
  type            ReportType
  rangeFrom       DateTime?  @db.Date
  rangeTo         DateTime?  @db.Date
  snapshotIdsHash String
  data            Json
  createdAt       DateTime   @default(now())

  @@index([type, rangeFrom, rangeTo])
}
